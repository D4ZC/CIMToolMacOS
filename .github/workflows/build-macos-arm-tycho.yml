name: Build CIMTool macOS ARM (Tycho)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version del producto (ej: 2.2.0)'
        required: true
        default: '2.2.0'

jobs:
  build-macos-arm:
    runs-on: macos-14

    steps:
      - name: Verificar ARM nativo
        run: uname -m && uname -a

      - name: Checkout CIMTool
        uses: actions/checkout@v4

      - name: Instalar Temurin 21 aarch64
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          architecture: aarch64

      - name: Instalar Maven
        run: brew install maven && mvn -version

      - name: Cache Maven y Tycho p2
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.cache/tycho
          key: tycho-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pom.xml', 'CIMToolProduct/CIMTool.target') }}
          restore-keys: tycho-${{ runner.os }}-${{ runner.arch }}-

      - name: Generar pom.xml de modulos con artifactId correcto
        run: python3 .github/scripts/generate-module-poms.py

      - name: Mostrar modulos detectados
        run: |
          echo "=== Modulos en pom.xml raiz ==="
          grep -A 30 '<modules>' pom.xml | head -35
          echo ""
          echo "=== artifactId de cada modulo ==="
          for f in */pom.xml; do
            echo "  $f -> $(grep '<artifactId>' $f | sed -n '2p' | xargs)"
          done

      - name: Build con Maven Tycho
        run: |
          mvn clean package \
            --batch-mode \
            --no-transfer-progress \
            -Dmaven.test.skip=true \
            -e \
            2>&1 | tee build.log
          if grep -q "BUILD FAILURE" build.log; then
            echo "=== BUILD FAILURE - ultimas 100 lineas ==="
            tail -100 build.log
            exit 1
          fi
          echo "=== BUILD SUCCESS ==="

      - name: Verificar artifacts generados
        run: |
          find CIMToolProduct/target -type f 2>/dev/null | sort || echo "No existe target/"
          MAC_ARTIFACT=$(find CIMToolProduct/target/products -name "*macosx*aarch64*" 2>/dev/null | head -1)
          if [ -z "$MAC_ARTIFACT" ]; then
            echo "ERROR: No se genero el artifact macOS aarch64"
            exit 1
          fi
          echo "Artifact: $MAC_ARTIFACT"
          ls -lh "$MAC_ARTIFACT"
          echo "MAC_ARTIFACT=$MAC_ARTIFACT" >> $GITHUB_ENV

      - name: Subir artifact macOS ARM
        uses: actions/upload-artifact@v4
        with:
          name: CIMTool-${{ github.event.inputs.version }}-macosx-cocoa-aarch64
          path: ${{ env.MAC_ARTIFACT }}
          retention-days: 30
          if-no-files-found: error

      - name: Subir log de build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
          if-no-files-found: ignore