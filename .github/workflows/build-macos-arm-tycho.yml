name: Build CIMTool macOS ARM (Tycho)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version del producto (ej: 2.2.0)'
        required: true
        default: '2.2.0'

jobs:
  build-macos-arm:
    runs-on: macos-14

    steps:
      - name: Verificar ARM nativo
        run: uname -m && uname -a

      - name: Checkout CIMTool
        uses: actions/checkout@v4

      - name: Instalar Temurin 21 aarch64
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          architecture: aarch64

      - name: Instalar Maven
        run: brew install maven && mvn -version

      - name: Cache Maven y Tycho p2
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.cache/tycho
          key: tycho-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('pom.xml', 'CIMToolProduct/CIMTool.target') }}
          restore-keys: tycho-${{ runner.os }}-${{ runner.arch }}-

      # Tycho exige que:
      #   artifactId  == Bundle-SymbolicName  (del MANIFEST.MF)
      #   <version>   == Bundle-Version       (del MANIFEST.MF)
      # Este paso genera pom.xml correctos leyendo ambos valores del MANIFEST.
      - name: Generar pom.xml de modulos con artifactId y version correctos
        run: |
          python3 << 'PYEOF'
          import os, re, textwrap

          POM_PLUGIN = textwrap.dedent("""\
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0"
                       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                       xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <parent>
                  <groupId>au.com.langdale.cimtool</groupId>
                  <artifactId>cimtool-parent</artifactId>
                  <version>2.2.0</version>
                  <relativePath>../pom.xml</relativePath>
                </parent>
                <artifactId>BSN_PLACEHOLDER</artifactId>
                <version>VER_PLACEHOLDER</version>
                <packaging>eclipse-plugin</packaging>
              </project>
              """)

          POM_FEATURE = textwrap.dedent("""\
              <?xml version="1.0" encoding="UTF-8"?>
              <project xmlns="http://maven.apache.org/POM/4.0.0"
                       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                       xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
                <modelVersion>4.0.0</modelVersion>
                <parent>
                  <groupId>au.com.langdale.cimtool</groupId>
                  <artifactId>cimtool-parent</artifactId>
                  <version>2.2.0</version>
                  <relativePath>../pom.xml</relativePath>
                </parent>
                <artifactId>BSN_PLACEHOLDER</artifactId>
                <version>VER_PLACEHOLDER</version>
                <packaging>eclipse-feature</packaging>
              </project>
              """)

          IGNORE = {'.git', '.github', 'docs', 'target'}
          included = []

          for d in sorted(os.listdir('.')):
              if not os.path.isdir(d) or d in IGNORE or d.startswith('.'):
                  continue

              manifest = os.path.join(d, 'META-INF', 'MANIFEST.MF')
              feature  = os.path.join(d, 'feature.xml')
              pom      = os.path.join(d, 'pom.xml')

              if os.path.exists(manifest):
                  txt = open(manifest, encoding='utf-8', errors='replace').read()
                  m_bsn = re.search(r'^Bundle-SymbolicName:\s*([^\s;]+)', txt, re.MULTILINE)
                  m_ver = re.search(r'^Bundle-Version:\s*([^\s]+)',        txt, re.MULTILINE)
                  if m_bsn:
                      bsn = m_bsn.group(1).strip()
                      ver = m_ver.group(1).strip() if m_ver else "0.0.0"
                      content = POM_PLUGIN.replace('BSN_PLACEHOLDER', bsn).replace('VER_PLACEHOLDER', ver)
                      open(pom, 'w').write(content)
                      included.append(d)
                      print(f"  [plugin]  {d:30s}  BSN={bsn}  v={ver}")
                  else:
                      print(f"  [skip]    {d:30s}  (MANIFEST sin Bundle-SymbolicName)")

              elif os.path.exists(feature):
                  txt = open(feature, encoding='utf-8', errors='replace').read()
                  m_id  = re.search(r'<feature[^>]+\bid=["\']([^"\']+)["\']',      txt)
                  m_ver = re.search(r'<feature[^>]+\bversion=["\']([^"\']+)["\']', txt)
                  fid = m_id.group(1)  if m_id  else d
                  ver = m_ver.group(1) if m_ver else "0.0.0"
                  content = POM_FEATURE.replace('BSN_PLACEHOLDER', fid).replace('VER_PLACEHOLDER', ver)
                  open(pom, 'w').write(content)
                  included.append(d)
                  print(f"  [feature] {d:30s}  id={fid}  v={ver}")

              elif os.path.exists(pom):
                  print(f"  [keep]    {d:30s}  (pom existente, sin MANIFEST/feature)")

          print(f"\nModulos procesados: {included}")
          PYEOF

      - name: Mostrar versiones detectadas por modulo
        run: |
          echo "=== artifactId y version por modulo ==="
          for f in */pom.xml; do
            AID=$(grep -m2 '<artifactId>' "$f" | tail -1 | tr -d ' <>/artifactId')
            VER=$(grep -m2 '<version>'    "$f" | tail -1 | tr -d ' <>/version')
            echo "  $f  ->  $AID  v$VER"
          done

      - name: Build con Maven Tycho
        run: |
          mvn clean package \
            --batch-mode \
            --no-transfer-progress \
            -Dmaven.test.skip=true \
            -e \
            2>&1 | tee build.log
          if grep -q "BUILD FAILURE" build.log; then
            echo "=== BUILD FAILURE - ultimas 100 lineas ==="
            tail -100 build.log
            exit 1
          fi
          echo "=== BUILD SUCCESS ==="

      - name: Verificar artifacts generados
        run: |
          find CIMToolProduct/target -type f 2>/dev/null | sort || echo "No existe target/"
          MAC_ARTIFACT=$(find CIMToolProduct/target/products -name "*macosx*aarch64*" 2>/dev/null | head -1)
          if [ -z "$MAC_ARTIFACT" ]; then
            echo "ERROR: No se genero el artifact macOS aarch64"
            exit 1
          fi
          echo "Artifact: $MAC_ARTIFACT"
          ls -lh "$MAC_ARTIFACT"
          echo "MAC_ARTIFACT=$MAC_ARTIFACT" >> $GITHUB_ENV

      - name: Subir artifact macOS ARM
        uses: actions/upload-artifact@v4
        with:
          name: CIMTool-${{ github.event.inputs.version }}-macosx-cocoa-aarch64
          path: ${{ env.MAC_ARTIFACT }}
          retention-days: 30
          if-no-files-found: error

      - name: Subir log de build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7
          if-no-files-found: ignore