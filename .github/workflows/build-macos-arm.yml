name: Build CIMTool macOS ARM

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version del producto (ej: 2.2.0)'
        required: true
        default: '2.2.0'

env:
  CIMTOOL_VERSION: ${{ github.event.inputs.version || '2.2.0' }}
  ECLIPSE_VERSION: 2023-06
  ECLIPSE_BUILD: R
  ECLIPSE_DROP: R-4.28-202306050440
  BUILD_DIR: ${{ github.workspace }}/build-output

jobs:
  build-macos-arm:
    runs-on: macos-14

    steps:
      # ── 1. VERIFICAR ARQUITECTURA ──────────────────────────────────────────
      - name: Verificar que el runner es ARM nativo
        run: |
          echo "=== Arquitectura del runner ==="
          uname -m
          uname -a

      # ── 2. CLONAR REPOSITORIO ──────────────────────────────────────────────
      - name: Checkout CIMTool
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ── 3. INSTALAR JDK ARM NATIVO ─────────────────────────────────────────
      - name: Instalar Temurin 21 para aarch64
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          architecture: aarch64

      - name: Verificar JDK ARM
        run: |
          java -version
          echo "JAVA_HOME: $JAVA_HOME"
          file $JAVA_HOME/bin/java

      # ── 4. CACHE ───────────────────────────────────────────────────────────
      - name: Cache Eclipse RCP y Platform Repo
        id: cache-eclipse
        uses: actions/cache@v4
        with:
          path: |
            $HOME/eclipse-rcp
            $HOME/platform-repo
          key: eclipse-${{ env.ECLIPSE_VERSION }}-${{ env.ECLIPSE_DROP }}-macos-aarch64-v3

      # ── 5. DESCARGAR ECLIPSE RCP macOS aarch64 ────────────────────────────
      - name: Descargar Eclipse RCP macOS ARM
        if: steps.cache-eclipse.outputs.cache-hit != 'true'
        run: |
          echo "=== Descargando Eclipse RCP 2023-06 para macOS aarch64 ==="
          ECLIPSE_URL="https://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release/${{ env.ECLIPSE_VERSION }}/${{ env.ECLIPSE_BUILD }}/eclipse-rcp-${{ env.ECLIPSE_VERSION }}-${{ env.ECLIPSE_BUILD }}-macosx-cocoa-aarch64.dmg&r=1"
          curl -L --retry 3 --retry-delay 5 -o /tmp/eclipse-rcp.dmg "$ECLIPSE_URL"
          ls -lh /tmp/eclipse-rcp.dmg
          hdiutil attach /tmp/eclipse-rcp.dmg -mountpoint /Volumes/EclipseRCP -nobrowse -quiet
          mkdir -p $HOME/eclipse-rcp
          cp -R "/Volumes/EclipseRCP/Eclipse.app" $HOME/eclipse-rcp/
          hdiutil detach /Volumes/EclipseRCP -quiet
          echo "Eclipse RCP instalado:"
          ls $HOME/eclipse-rcp/Eclipse.app/Contents/Eclipse/

      # ── 6. DESCARGAR PLATFORM RUNTIME REPO ───────────────────────────────
      # CLAVE: La URL es DIRECTA a archive.eclipse.org apuntando al archivo.
      # NO usar download.php (devuelve pagina HTML de click-through, no el ZIP).
      # org.eclipse.platform-4.28.zip (~110MB) contiene fragmentos para
      # todas las plataformas, incluida macosx.cocoa.aarch64.
      - name: Descargar Eclipse Platform Runtime Repo
        if: steps.cache-eclipse.outputs.cache-hit != 'true'
        run: |
          echo "=== Descargando org.eclipse.platform-4.28.zip ==="

          DIRECT_URL="https://archive.eclipse.org/eclipse/downloads/drops4/${{ env.ECLIPSE_DROP }}/org.eclipse.platform-4.28.zip"
          echo "URL: $DIRECT_URL"

          curl -L --retry 3 --retry-delay 5 --progress-bar \
               -o /tmp/platform-repo.zip \
               "$DIRECT_URL"

          echo "Descarga completada:"
          ls -lh /tmp/platform-repo.zip
          file /tmp/platform-repo.zip

          if ! unzip -t /tmp/platform-repo.zip > /dev/null 2>&1; then
            echo "ERROR: No es un ZIP valido. Contenido:"
            head -5 /tmp/platform-repo.zip
            exit 1
          fi

          mkdir -p $HOME/platform-repo
          unzip -q /tmp/platform-repo.zip -d $HOME/platform-repo
          echo "=== Fragmentos aarch64 encontrados: ==="
          find $HOME/platform-repo -name "*aarch64*" | head -20

      # ── 7. CONFIGURAR TARGET PLATFORM ─────────────────────────────────────
      - name: Configurar Target Platform
        run: |
          ECLIPSE_HOME="$HOME/eclipse-rcp/Eclipse.app/Contents/Eclipse"
          PLATFORM_REPO="$HOME/platform-repo"
          TARGET="$HOME/target-platform"

          mkdir -p "$TARGET/plugins" "$TARGET/features"

          echo "Copiando plugins de Eclipse RCP base..."
          cp -Rf "$ECLIPSE_HOME/plugins"/. "$TARGET/plugins/"

          echo "Mergeando plugins del Platform Runtime Repo..."
          REPO_PLUGINS=$(find "$PLATFORM_REPO" -type d -name "plugins" | head -1)
          if [ -n "$REPO_PLUGINS" ]; then
            cp -Rn "$REPO_PLUGINS"/. "$TARGET/plugins/"
            echo "Plugins mergeados desde: $REPO_PLUGINS"
          else
            echo "ADVERTENCIA: No se encontro carpeta plugins"
            find "$PLATFORM_REPO" -maxdepth 3 -type d | head -20
          fi

          echo "=== Verificando SWT para macOS ARM ==="
          SWT_AARCH=$(find "$TARGET/plugins" -name "*swt*cocoa*aarch64*" | head -3)
          if [ -z "$SWT_AARCH" ]; then
            echo "ERROR: No se encontro SWT para macosx.cocoa.aarch64"
            find "$TARGET/plugins" -name "*swt*" | head -20
            exit 1
          fi
          echo "SWT aarch64 encontrado: $SWT_AARCH"

          echo "TARGET_PLATFORM=$TARGET" >> $GITHUB_ENV
          echo "ECLIPSE_HOME=$ECLIPSE_HOME" >> $GITHUB_ENV

      # ── 8. PREPARAR DIRECTORIO DE BUILD ───────────────────────────────────
      - name: Preparar directorio de output
        run: |
          mkdir -p "$BUILD_DIR"
          echo "=== Estructura del proyecto ==="
          ls -la $GITHUB_WORKSPACE/
          echo "=== CIMToolProduct ==="
          ls -la $GITHUB_WORKSPACE/CIMToolProduct/ || echo "No se encontro CIMToolProduct/"

      # ── 9. PDE HEADLESS EXPORT ─────────────────────────────────────────────
      - name: Ejecutar PDE Headless Export para macOS ARM
        run: |
          ECLIPSE_EXEC="$ECLIPSE_HOME/eclipse"
          PDE_BUILD_SCRIPTS=$(ls -d $TARGET_PLATFORM/plugins/org.eclipse.pde.build_* 2>/dev/null | head -1)

          echo "PDE Build scripts: $PDE_BUILD_SCRIPTS"
          echo "Eclipse executable: $ECLIPSE_EXEC"

          "$ECLIPSE_EXEC" \
            -nosplash \
            -consoleLog \
            -application org.eclipse.ant.core.antRunner \
            -buildfile "$PDE_BUILD_SCRIPTS/scripts/productBuild/productBuild.xml" \
            -Dbuilder="$GITHUB_WORKSPACE/CIMToolProduct" \
            -DtopLevelElementId=au.com.langdale.cimtool.product \
            -Dproduct="$GITHUB_WORKSPACE/CIMToolProduct/CIMTool.product" \
            -DbaseLocation="$TARGET_PLATFORM" \
            -DbuildDirectory="$BUILD_DIR" \
            -Dconfigs="macosx,cocoa,aarch64" \
            -DarchivePrefix="CIMTool-${{ env.CIMTOOL_VERSION }}" \
            -DcollectingFolder="CIMTool-${{ env.CIMTOOL_VERSION }}" \
            -DarchivesFormat="macosx,cocoa,aarch64-zip" \
            -DbuildType=I \
            -DjavacSource=21 \
            -DjavacTarget=21 \
            -DforceContextQualifier=$(date +%Y%m%d%H%M) \
            -Djvm="$JAVA_HOME/bin/java" \
            -DskipMirroring=true \
            -DskipDirector=true \
            2>&1 | tee $BUILD_DIR/build.log

      # ── 10. VERIFICAR OUTPUT ───────────────────────────────────────────────
      - name: Verificar archivos generados
        run: |
          echo "=== Archivos generados ==="
          find "$BUILD_DIR" -type f | sort
          find "$BUILD_DIR" -name "*.zip" -exec ls -lh {} \;

          MAC_ZIP=$(find "$BUILD_DIR" -name "*macosx*aarch64*.zip" | head -1)
          if [ -z "$MAC_ZIP" ]; then
            echo "ERROR: No se genero el ZIP para macOS aarch64"
            tail -100 "$BUILD_DIR/build.log"
            exit 1
          fi

          echo "ZIP generado: $MAC_ZIP"
          echo "MAC_ZIP=$MAC_ZIP" >> $GITHUB_ENV

      # ── 11. RENOMBRAR ARTIFACT ─────────────────────────────────────────────
      - name: Renombrar con convencion oficial
        run: |
          FINAL_NAME="CIMTool-${{ env.CIMTOOL_VERSION }}-macosx.cocoa.aarch64.zip"
          cp "$MAC_ZIP" "$BUILD_DIR/$FINAL_NAME"
          echo "FINAL_ZIP=$BUILD_DIR/$FINAL_NAME" >> $GITHUB_ENV
          ls -lh "$BUILD_DIR/$FINAL_NAME"

      # ── 12. SUBIR ARTIFACT ─────────────────────────────────────────────────
      - name: Subir artifact macOS ARM
        uses: actions/upload-artifact@v4
        with:
          name: CIMTool-${{ env.CIMTOOL_VERSION }}-macosx-cocoa-aarch64
          path: ${{ env.FINAL_ZIP }}
          retention-days: 30
          if-no-files-found: error

      # ── 13. SUBIR LOG (siempre, incluso si falla) ──────────────────────────
      - name: Subir log de build
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ env.BUILD_DIR }}/build.log
          retention-days: 7
          if-no-files-found: ignore
